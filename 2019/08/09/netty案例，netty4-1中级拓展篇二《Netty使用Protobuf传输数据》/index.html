<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000">
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top">
  
  
  <title>netty案例，netty4.1中级拓展篇二《Netty使用Protobuf传输数据》 | bugstack虫洞栈 | 沉淀、分享、成长，专注于原创专题案例，以最易学习编程的方式分享知识，让自己和他人都能有所收获</title>
  <meta name="description" content="前言介绍在netty数据传输过程中可以有很多选择，比如；字符串、json、xml、java对象，但为了保证传输的数据具备；良好的通用性、方便的操作性和传输的高性能，我们可以选择protobuf作为我们的数据传输格式。目前protobuf可以支持；C++、C#、Dart、Go、Java、Python等，也可以在JS里使用。知识点；ProtobufDecoder、ProtobufEncoder、Pro">
<meta name="keywords" content="netty">
<meta property="og:type" content="article">
<meta property="og:title" content="netty案例，netty4.1中级拓展篇二《Netty使用Protobuf传输数据》">
<meta property="og:url" content="//itstack.org/2019/08/09/netty案例，netty4-1中级拓展篇二《Netty使用Protobuf传输数据》/index.html">
<meta property="og:site_name" content="itstack.org 守一片边疆，护一国城邦。">
<meta property="og:description" content="前言介绍在netty数据传输过程中可以有很多选择，比如；字符串、json、xml、java对象，但为了保证传输的数据具备；良好的通用性、方便的操作性和传输的高性能，我们可以选择protobuf作为我们的数据传输格式。目前protobuf可以支持；C++、C#、Dart、Go、Java、Python等，也可以在JS里使用。知识点；ProtobufDecoder、ProtobufEncoder、Pro">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://bugstack.cn/wp-content/uploads/2019/08/netty-2-02-1.png">
<meta property="og:image" content="https://bugstack.cn/wp-content/uploads/2019/08/netty-2-02-2.png">
<meta property="og:image" content="https://bugstack.cn/wp-content/uploads/2019/08/qrcode清晰.png">
<meta property="og:updated_time" content="2019-11-08T13:43:18.200Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="netty案例，netty4.1中级拓展篇二《Netty使用Protobuf传输数据》">
<meta name="twitter:description" content="前言介绍在netty数据传输过程中可以有很多选择，比如；字符串、json、xml、java对象，但为了保证传输的数据具备；良好的通用性、方便的操作性和传输的高性能，我们可以选择protobuf作为我们的数据传输格式。目前protobuf可以支持；C++、C#、Dart、Go、Java、Python等，也可以在JS里使用。知识点；ProtobufDecoder、ProtobufEncoder、Pro">
<meta name="twitter:image" content="https://bugstack.cn/wp-content/uploads/2019/08/netty-2-02-1.png">
  <!-- Canonical links -->
  <link rel="canonical" href="//itstack.org/2019/08/09/netty案例，netty4-1中级拓展篇二《Netty使用Protobuf传输数据》/index.html">
  
    <link rel="alternate" href="/atom.xml" title="itstack.org 守一片边疆，护一国城邦。" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  <link rel="stylesheet" href="/css/style.css">
  
  
  
  
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.min.css">
  
</head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/fuzhengwei" target="_blank">
          <img class="img-circle img-rotate" src="/images/touxiang.png" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">付政委</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">沉淀、分享、成长</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> BeiJing, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search">
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="Type something..." x-webkit-speech>
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">Home</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/归档">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">Archives</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/分类">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">Categories</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/标签">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">Tags</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/Github">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">Repository</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-books">
          <a href="/书单">
            
            <i class="icon icon-book-fill"></i>
            
            <span class="menu-title">Books</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/友链">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">Links</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/关于">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">About</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/fuzhengwei" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">Board</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>欢迎交流与分享经验!</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">Categories</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/JVM实战/">JVM实战</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Netty4-1案例/">Netty4.1案例</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/手写RPC框架/">手写RPC框架</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/用Java实现JVM/">用Java实现JVM</a><span class="category-list-count">12</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tags</h3>
    <div class="widget-body">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/dubbo/">dubbo</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javaagent/">javaagent</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jcommander/">jcommander</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jvm/">jvm</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jvmti/">jvmti</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/netty/">netty</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rpc/">rpc</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/字节码/">字节码</a><span class="tag-list-count">3</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/dubbo/" style="font-size: 13.33px;">dubbo</a> <a href="/tags/javaagent/" style="font-size: 13px;">javaagent</a> <a href="/tags/jcommander/" style="font-size: 13px;">jcommander</a> <a href="/tags/jvm/" style="font-size: 13.67px;">jvm</a> <a href="/tags/jvmti/" style="font-size: 13px;">jvmti</a> <a href="/tags/netty/" style="font-size: 14px;">netty</a> <a href="/tags/rpc/" style="font-size: 13.33px;">rpc</a> <a href="/tags/字节码/" style="font-size: 13.33px;">字节码</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">Archive</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a><span class="archive-list-count">17</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Netty4-1案例/">Netty4.1案例</a>
              </p>
              <p class="item-title">
                <a href="/2019/08/09/netty案例，netty4-1中级拓展篇五《基于Netty搭建WebSocket，模仿微信聊天页面》/" class="title">netty案例，netty4.1中级拓展篇五《基于Netty搭建WebSocket，模仿微信聊天页面》</a>
              </p>
              <p class="item-date">
                <time datetime="2019-08-09T14:08:38.000Z" itemprop="datePublished">2019-08-09</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Netty4-1案例/">Netty4.1案例</a>
              </p>
              <p class="item-title">
                <a href="/2019/08/09/netty案例，netty4-1中级拓展篇四《Netty传输文件、分片发送、断点续传》/" class="title">netty案例，netty4.1中级拓展篇四《Netty传输文件、分片发送、断点续传》</a>
              </p>
              <p class="item-date">
                <time datetime="2019-08-09T14:05:00.000Z" itemprop="datePublished">2019-08-09</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Netty4-1案例/">Netty4.1案例</a>
              </p>
              <p class="item-title">
                <a href="/2019/08/09/netty案例，netty4-1中级拓展篇三《Netty传输Java对象》/" class="title">netty案例，netty4.1中级拓展篇三《Netty传输Java对象》</a>
              </p>
              <p class="item-date">
                <time datetime="2019-08-09T14:04:08.000Z" itemprop="datePublished">2019-08-09</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Netty4-1案例/">Netty4.1案例</a>
              </p>
              <p class="item-title">
                <a href="/2019/08/09/netty案例，netty4-1中级拓展篇二《Netty使用Protobuf传输数据》/" class="title">netty案例，netty4.1中级拓展篇二《Netty使用Protobuf传输数据》</a>
              </p>
              <p class="item-date">
                <time datetime="2019-08-09T14:03:25.000Z" itemprop="datePublished">2019-08-09</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Netty4-1案例/">Netty4.1案例</a>
              </p>
              <p class="item-title">
                <a href="/2019/08/09/netty案例，netty4-1中级拓展篇一《Netty与SpringBoot整合》/" class="title">netty案例，netty4.1中级拓展篇一《Netty与SpringBoot整合》</a>
              </p>
              <p class="item-date">
                <time datetime="2019-08-09T14:02:34.000Z" itemprop="datePublished">2019-08-09</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<main class="main" role="main">
  <div class="content">
  <article id="post-netty案例，netty4-1中级拓展篇二《Netty使用Protobuf传输数据》" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      netty案例，netty4.1中级拓展篇二《Netty使用Protobuf传输数据》
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2019/08/09/netty案例，netty4-1中级拓展篇二《Netty使用Protobuf传输数据》/" class="article-date">
	  <time datetime="2019-08-09T14:03:25.000Z" itemprop="datePublished">2019-08-09</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Netty4-1案例/">Netty4.1案例</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link" href="/tags/netty/">netty</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2019/08/09/netty案例，netty4-1中级拓展篇二《Netty使用Protobuf传输数据》/#comments" class="article-comment-link">Comments</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h2 id="前言介绍"><a href="#前言介绍" class="headerlink" title="前言介绍"></a>前言介绍</h2><p>在netty数据传输过程中可以有很多选择，比如；字符串、json、xml、java对象，但为了保证传输的数据具备；良好的通用性、方便的操作性和传输的高性能，我们可以选择protobuf作为我们的数据传输格式。目前protobuf可以支持；C++、C#、Dart、Go、Java、Python等，也可以在JS里使用。知识点；ProtobufDecoder、ProtobufEncoder、ProtobufVarint32FrameDecoder、ProtobufVarint32LengthFieldPrepender。</p>
<blockquote>
<p>What are protocol buffers?<br>Protocol buffers are Google’s language-neutral, platform-neutral, extensible mechanism for serializing structured data – think XML, but smaller, faster, and simpler. You define how you want your data to be structured once, then you can use special generated source code to easily write and read your structured data to and from a variety of data streams and using a variety of languages. <a href="https://developers.google.cn/protocol-buffers" target="_blank" rel="noopener">https://developers.google.cn/protocol-buffers</a></p>
</blockquote>
<h2 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h2><p>1、jdk1.8【jdk1.7以下只能部分支持netty】<br>2、Netty4.1.36.Final【netty3.x 4.x 5每次的变化较大，接口类名也随着变化】<br>3、protoc-3.5.0-win32 【用于编译proto文件(protoc -I=源地址 –java_out=目标地址  源地址/xxx.proto)，源码中已经提供，如果是其他开发环境可以自行下载】</p>
<h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">itstack-demo-netty-<span class="number">2</span>-<span class="number">02</span></span><br><span class="line">└── src</span><br><span class="line">    ├── main</span><br><span class="line">    │   └── java</span><br><span class="line">    │       └── org.itstack.demo.netty</span><br><span class="line">    │           ├── client</span><br><span class="line">    │           │	├── MyChannelInitializer.java</span><br><span class="line">    │           │	├── MyClientHandler.java</span><br><span class="line">    │           │	└── NettyClient.java</span><br><span class="line">    │           ├── domain</span><br><span class="line">    │           │	├── MsgBody.java</span><br><span class="line">    │           │	├── MsgBodyOrBuilder.java</span><br><span class="line">    │           │	└── MsgInfo.java</span><br><span class="line">    │           ├── proto</span><br><span class="line">    │           │	└── MsgInfo.proto</span><br><span class="line">    │           ├── server</span><br><span class="line">    │           │	├── MyChannelInitializer.java</span><br><span class="line">    │           │	├── MyServerHandler.java</span><br><span class="line">    │           │	└── NettyServer.java</span><br><span class="line">    │           └── util</span><br><span class="line">    │           	└── MsgUtil.java</span><br><span class="line">    │</span><br><span class="line">    └── test</span><br><span class="line">         └── java</span><br><span class="line">             └── org.itstack.demo.test</span><br><span class="line">                 └── ApiTest.java</span><br></pre></td></tr></table></figure>
<blockquote>
<p>client/MyChannelInitializer.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">**</span><br><span class="line"> * 虫洞栈：https:<span class="comment">//bugstack.cn</span></span><br><span class="line"> * 公众号：bugstack虫洞栈  ｛获取学习源码｝</span><br><span class="line"> * Create by fuzhengwei on <span class="number">2019</span></span><br><span class="line"> */</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyChannelInitializer</span> <span class="keyword">extends</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel channel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//protobuf 处理</span></span><br><span class="line">        channel.pipeline().addLast(<span class="keyword">new</span> ProtobufVarint32FrameDecoder());</span><br><span class="line">        channel.pipeline().addLast(<span class="keyword">new</span> ProtobufDecoder(MsgBody.getDefaultInstance()));</span><br><span class="line">        channel.pipeline().addLast(<span class="keyword">new</span> ProtobufVarint32LengthFieldPrepender());</span><br><span class="line">        channel.pipeline().addLast(<span class="keyword">new</span> ProtobufEncoder());</span><br><span class="line">        <span class="comment">// 在管道中添加我们自己的接收数据实现方法</span></span><br><span class="line">        channel.pipeline().addLast(<span class="keyword">new</span> MyClientHandler());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>client/MyClientHandler.java </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 虫洞栈：https://bugstack.cn</span></span><br><span class="line"><span class="comment"> * 公众号：bugstack虫洞栈  ｛获取学习源码｝</span></span><br><span class="line"><span class="comment"> * Create by fuzhengwei on 2019</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClientHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当客户端主动链接服务端的链接后，这个通道就是活跃的了。也就是客户端与服务端建立了通信通道并且可以传输数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SocketChannel channel = (SocketChannel) ctx.channel();</span><br><span class="line">        System.out.println(<span class="string">"链接报告开始"</span>);</span><br><span class="line">        System.out.println(<span class="string">"链接报告信息：本客户端链接到服务端。channelId："</span> + channel.id());</span><br><span class="line">        System.out.println(<span class="string">"链接报告IP:"</span> + channel.localAddress().getHostString());</span><br><span class="line">        System.out.println(<span class="string">"链接报告Port:"</span> + channel.localAddress().getPort());</span><br><span class="line">        System.out.println(<span class="string">"链接报告完毕"</span>);</span><br><span class="line">        <span class="comment">//通知客户端链接建立成功</span></span><br><span class="line">        String str = <span class="string">"通知服务端链接建立成功"</span> + <span class="string">" "</span> + <span class="keyword">new</span> Date() + <span class="string">" "</span> + channel.localAddress().getHostString();</span><br><span class="line">        ctx.writeAndFlush(MsgUtil.buildMsg(channel.id().toString(), str));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当客户端主动断开服务端的链接后，这个通道就是不活跃的。也就是说客户端与服务端的关闭了通信通道并且不可以传输数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"断开链接"</span> + ctx.channel().localAddress().toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//接收msg消息&#123;与上一章节相比，此处已经不需要自己进行解码&#125;</span></span><br><span class="line">        System.out.println(<span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>).format(<span class="keyword">new</span> Date()) + <span class="string">" 接收到消息类型："</span> + msg.getClass());</span><br><span class="line">        System.out.println(<span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>).format(<span class="keyword">new</span> Date()) + <span class="string">" 接收到消息内容："</span> + JsonFormat.printToString((MsgBody) msg));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 抓住异常，当发生异常的时候，可以做一些相应的处理，比如打印日志、关闭链接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">        System.out.println(<span class="string">"异常信息：\r\n"</span> + cause.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>client/NettyClient.java </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 虫洞栈：https://bugstack.cn</span></span><br><span class="line"><span class="comment"> * 公众号：bugstack虫洞栈  ｛获取学习源码｝</span></span><br><span class="line"><span class="comment"> * Create by fuzhengwei on 2019</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> NettyClient().connect(<span class="string">"127.0.0.1"</span>, <span class="number">7397</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">(String inetHost, <span class="keyword">int</span> inetPort)</span> </span>&#123;</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Bootstrap b = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">            b.group(workerGroup);</span><br><span class="line">            b.channel(NioSocketChannel.class);</span><br><span class="line">            b.option(ChannelOption.AUTO_READ, <span class="keyword">true</span>);</span><br><span class="line">            b.handler(<span class="keyword">new</span> MyChannelInitializer());</span><br><span class="line">            ChannelFuture f = b.connect(inetHost, inetPort).sync();</span><br><span class="line">            System.out.println(<span class="string">"itstack-demo-netty client start done. &#123;关注公众号：bugstack虫洞栈，获取源码&#125;"</span>);</span><br><span class="line"></span><br><span class="line">            f.channel().writeAndFlush(MsgUtil.buildMsg(f.channel().id().toString(),<span class="string">"你好，使用protobuf通信格式的服务端，我是https://bugstack.cn博主，付政委。这是我的公众号&lt;bugstack虫洞栈&gt;，关注我获取案例源码。"</span>));</span><br><span class="line">            f.channel().writeAndFlush(MsgUtil.buildMsg(f.channel().id().toString(),<span class="string">"你好，使用protobuf通信格式的服务端，我是https://bugstack.cn博主，付政委。这是我的公众号&lt;bugstack虫洞栈&gt;，关注我获取案例源码。"</span>));</span><br><span class="line">            f.channel().writeAndFlush(MsgUtil.buildMsg(f.channel().id().toString(),<span class="string">"你好，使用protobuf通信格式的服务端，我是https://bugstack.cn博主，付政委。这是我的公众号&lt;bugstack虫洞栈&gt;，关注我获取案例源码。"</span>));</span><br><span class="line">            f.channel().writeAndFlush(MsgUtil.buildMsg(f.channel().id().toString(),<span class="string">"你好，使用protobuf通信格式的服务端，我是https://bugstack.cn博主，付政委。这是我的公众号&lt;bugstack虫洞栈&gt;，关注我获取案例源码。"</span>));</span><br><span class="line">            f.channel().writeAndFlush(MsgUtil.buildMsg(f.channel().id().toString(),<span class="string">"你好，使用protobuf通信格式的服务端，我是https://bugstack.cn博主，付政委。这是我的公众号&lt;bugstack虫洞栈&gt;，关注我获取案例源码。"</span>));</span><br><span class="line"></span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>proto/MsgInfo.proto </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.itstack.demo.netty.domain;</span><br><span class="line"></span><br><span class="line">option java_package = <span class="string">"org.itstack.demo.netty.domain"</span>;</span><br><span class="line">option java_multiple_files = <span class="keyword">true</span>;</span><br><span class="line">option java_outer_classname = <span class="string">"MsgInfo"</span>;</span><br><span class="line"></span><br><span class="line">message MsgBody &#123;</span><br><span class="line"></span><br><span class="line">    string channelId = <span class="number">1</span>;</span><br><span class="line">    string msgInfo = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>server/MyChannelInitializer.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 虫洞栈：https://bugstack.cn</span></span><br><span class="line"><span class="comment"> * 公众号：bugstack虫洞栈  ｛获取学习源码｝</span></span><br><span class="line"><span class="comment"> * Create by fuzhengwei on 2019</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyChannelInitializer</span> <span class="keyword">extends</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel channel)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//protobuf 处理</span></span><br><span class="line">        channel.pipeline().addLast(<span class="keyword">new</span> ProtobufVarint32FrameDecoder());</span><br><span class="line">        channel.pipeline().addLast(<span class="keyword">new</span> ProtobufDecoder(MsgBody.getDefaultInstance()));</span><br><span class="line">        channel.pipeline().addLast(<span class="keyword">new</span> ProtobufVarint32LengthFieldPrepender());</span><br><span class="line">        channel.pipeline().addLast(<span class="keyword">new</span> ProtobufEncoder());</span><br><span class="line">        <span class="comment">// 在管道中添加我们自己的接收数据实现方法</span></span><br><span class="line">        channel.pipeline().addLast(<span class="keyword">new</span> MyServerHandler());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>server/MyServerHandler.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 虫洞栈：https://bugstack.cn</span></span><br><span class="line"><span class="comment"> * 公众号：bugstack虫洞栈  ｛获取学习源码｝</span></span><br><span class="line"><span class="comment"> * Create by fuzhengwei on 2019</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServerHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当客户端主动链接服务端的链接后，这个通道就是活跃的了。也就是客户端与服务端建立了通信通道并且可以传输数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SocketChannel channel = (SocketChannel) ctx.channel();</span><br><span class="line">        System.out.println(<span class="string">"链接报告开始"</span>);</span><br><span class="line">        System.out.println(<span class="string">"链接报告信息：有一客户端链接到本服务端。channelId："</span> + channel.id());</span><br><span class="line">        System.out.println(<span class="string">"链接报告IP:"</span> + channel.localAddress().getHostString());</span><br><span class="line">        System.out.println(<span class="string">"链接报告Port:"</span> + channel.localAddress().getPort());</span><br><span class="line">        System.out.println(<span class="string">"链接报告完毕"</span>);</span><br><span class="line">        <span class="comment">//通知客户端链接建立成功</span></span><br><span class="line">        String str = <span class="string">"通知客户端链接建立成功"</span> + <span class="string">" "</span> + <span class="keyword">new</span> Date() + <span class="string">" "</span> + channel.localAddress().getHostString() + <span class="string">"\r\n"</span>;</span><br><span class="line">        ctx.writeAndFlush(MsgUtil.buildMsg(channel.id().toString(), str));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当客户端主动断开服务端的链接后，这个通道就是不活跃的。也就是说客户端与服务端的关闭了通信通道并且不可以传输数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"客户端断开链接"</span> + ctx.channel().localAddress().toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//接收msg消息&#123;与上一章节相比，此处已经不需要自己进行解码&#125;</span></span><br><span class="line">        System.out.println(<span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>).format(<span class="keyword">new</span> Date()) + <span class="string">" 接收到消息类型："</span> + msg.getClass());</span><br><span class="line">        System.out.println(<span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>).format(<span class="keyword">new</span> Date()) + <span class="string">" 接收到消息内容："</span> + JsonFormat.printToString((MsgBody) msg));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 抓住异常，当发生异常的时候，可以做一些相应的处理，比如打印日志、关闭链接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">        System.out.println(<span class="string">"异常信息：\r\n"</span> + cause.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>server/NettyServer.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 虫洞栈：https://bugstack.cn</span></span><br><span class="line"><span class="comment"> * 公众号：bugstack虫洞栈  ｛获取学习源码｝</span></span><br><span class="line"><span class="comment"> * Create by fuzhengwei on 2019</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> NettyServer().bing(<span class="number">7397</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bing</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//配置服务端NIO线程组</span></span><br><span class="line">        EventLoopGroup parentGroup = <span class="keyword">new</span> NioEventLoopGroup(); <span class="comment">//NioEventLoopGroup extends MultithreadEventLoopGroup Math.max(1, SystemPropertyUtil.getInt("io.netty.eventLoopThreads", NettyRuntime.availableProcessors() * 2));</span></span><br><span class="line">        EventLoopGroup childGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ServerBootstrap b = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">            b.group(parentGroup, childGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)    <span class="comment">//非阻塞模式</span></span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> MyChannelInitializer());</span><br><span class="line">            ChannelFuture f = b.bind(port).sync();</span><br><span class="line">            System.out.println(<span class="string">"itstack-demo-netty server start done. &#123;关注公众号：bugstack虫洞栈，获取源码&#125;"</span>);</span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            childGroup.shutdownGracefully();</span><br><span class="line">            parentGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>util/MsgUtil.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 虫洞栈：https://bugstack.cn</span></span><br><span class="line"><span class="comment"> * 公众号：bugstack虫洞栈  ｛获取学习源码｝</span></span><br><span class="line"><span class="comment"> * Create by fuzhengwei on 2019</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MsgUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建protobuf消息体</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MsgBody <span class="title">buildMsg</span><span class="params">(String channelId, String msgInfo)</span> </span>&#123;</span><br><span class="line">        MsgBody.Builder msg = MsgBody.newBuilder();</span><br><span class="line">        msg.setChannelId(channelId);</span><br><span class="line">        msg.setMsgInfo(msgInfo);</span><br><span class="line">        <span class="keyword">return</span> msg.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ApiTest.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 虫洞栈：https://bugstack.cn</span></span><br><span class="line"><span class="comment"> * 公众号：bugstack虫洞栈  ｛获取学习源码｝</span></span><br><span class="line"><span class="comment"> * Create by fuzhengwei on 2019</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> JsonFormat.ParseException </span>&#123;</span><br><span class="line">        MsgBody.Builder msg = MsgBody.newBuilder();</span><br><span class="line">        msg.setChannelId(<span class="string">"abD01223"</span>);</span><br><span class="line">        msg.setMsgInfo(<span class="string">"hi helloworld"</span>);</span><br><span class="line">        MsgBody msgBody = msg.build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//protobuf转Json 需要引入protobuf-java-format</span></span><br><span class="line">        String msgBodyStr = JsonFormat.printToString(msgBody);</span><br><span class="line">        System.out.println(msgBodyStr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//json转protobuf 需要引入protobuf-java-format</span></span><br><span class="line">        JsonFormat.merge(<span class="string">"&#123;\"channelId\": \"HBdhi993\",\"msgInfo\": \"hi bugstack虫洞栈\"&#125;"</span>, msg);</span><br><span class="line">        msgBody = msg.build();</span><br><span class="line">        System.out.println(msgBody.getChannelId());</span><br><span class="line">        System.out.println(msgBody.getMsgInfo());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h2><blockquote>
<p>编译proto *idea的Terminal下执行编译命令</p>
</blockquote>
<p>操作：idea选中E:\itstack\GIT\itstack.org\itstack-demo-netty\itstack-demo-netty-2-02\protoc-3.5.0-win32\bin<br>命令：protoc -I=源地址 –java_out=目标地址  源地址/xxx.proto<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">E:\itstack\GIT\itstack.org\itstack-demo-netty\itstack-demo-netty-<span class="number">2</span>-<span class="number">02</span>\protoc-<span class="number">3.5</span>.0-win32\bin&gt;protoc.exe -I=E:\itstack\GIT\itstack.org\itstack-demo-netty\itstack-demo-netty-<span class="number">2</span>-<span class="number">02</span>\src\main\java\org\itstack\demo\netty\proto --java_out=E:\itstack\GIT\itstack.org\itstack-demo-netty\itstack-demo-netty-<span class="number">2</span>-<span class="number">02</span>\src\main</span><br><span class="line">\java MsgInfo.proto</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>启动NettyServer</p>
</blockquote>
<p><img src="https://bugstack.cn/wp-content/uploads/2019/08/netty-2-02-1.png" alt></p>
<blockquote>
<p>启动NettyClient</p>
</blockquote>
<p><img src="https://bugstack.cn/wp-content/uploads/2019/08/netty-2-02-2.png" alt></p>
<blockquote>
<p>服务端执行结果</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">itstack-demo-netty server start done. &#123;关注公众号：bugstack虫洞栈，获取源码&#125;</span><br><span class="line">链接报告开始</span><br><span class="line">链接报告信息：有一客户端链接到本服务端。channelId：<span class="number">807679</span>da</span><br><span class="line">链接报告IP:<span class="number">127.0</span>.0.1</span><br><span class="line">链接报告Port:<span class="number">7397</span></span><br><span class="line">链接报告完毕</span><br><span class="line"><span class="number">2019</span>-<span class="number">08</span>-<span class="number">04</span> <span class="number">14</span>:<span class="number">06</span>:<span class="number">01</span> 接收到消息类型：<span class="class"><span class="keyword">class</span> <span class="title">org</span>.<span class="title">itstack</span>.<span class="title">demo</span>.<span class="title">netty</span>.<span class="title">domain</span>.<span class="title">MsgBody</span></span></span><br><span class="line">2019-08-04 14:06:01 接收到消息内容：&#123;"channelId": "abc14b89","msgInfo": "通知服务端链接建立成功 Sun Aug 04 14:06:01 CST 2019 127.0.0.1"&#125;</span><br><span class="line"><span class="number">2019</span>-<span class="number">08</span>-<span class="number">04</span> <span class="number">14</span>:<span class="number">06</span>:<span class="number">01</span> 接收到消息类型：<span class="class"><span class="keyword">class</span> <span class="title">org</span>.<span class="title">itstack</span>.<span class="title">demo</span>.<span class="title">netty</span>.<span class="title">domain</span>.<span class="title">MsgBody</span></span></span><br><span class="line">2019-08-04 14:06:01 接收到消息内容：&#123;"channelId": "abc14b89","msgInfo": "你好，使用protobuf通信格式的服务端，我是https://bugstack.cn博主，付政委。这是我的公众号&lt;bugstack虫洞栈&gt;，关注我获取案例源码。"&#125;</span><br><span class="line"><span class="number">2019</span>-<span class="number">08</span>-<span class="number">04</span> <span class="number">14</span>:<span class="number">06</span>:<span class="number">01</span> 接收到消息类型：<span class="class"><span class="keyword">class</span> <span class="title">org</span>.<span class="title">itstack</span>.<span class="title">demo</span>.<span class="title">netty</span>.<span class="title">domain</span>.<span class="title">MsgBody</span></span></span><br><span class="line">2019-08-04 14:06:01 接收到消息内容：&#123;"channelId": "abc14b89","msgInfo": "你好，使用protobuf通信格式的服务端，我是https://bugstack.cn博主，付政委。这是我的公众号&lt;bugstack虫洞栈&gt;，关注我获取案例源码。"&#125;</span><br><span class="line"><span class="number">2019</span>-<span class="number">08</span>-<span class="number">04</span> <span class="number">14</span>:<span class="number">06</span>:<span class="number">01</span> 接收到消息类型：<span class="class"><span class="keyword">class</span> <span class="title">org</span>.<span class="title">itstack</span>.<span class="title">demo</span>.<span class="title">netty</span>.<span class="title">domain</span>.<span class="title">MsgBody</span></span></span><br><span class="line">2019-08-04 14:06:01 接收到消息内容：&#123;"channelId": "abc14b89","msgInfo": "你好，使用protobuf通信格式的服务端，我是https://bugstack.cn博主，付政委。这是我的公众号&lt;bugstack虫洞栈&gt;，关注我获取案例源码。"&#125;</span><br><span class="line"><span class="number">2019</span>-<span class="number">08</span>-<span class="number">04</span> <span class="number">14</span>:<span class="number">06</span>:<span class="number">01</span> 接收到消息类型：<span class="class"><span class="keyword">class</span> <span class="title">org</span>.<span class="title">itstack</span>.<span class="title">demo</span>.<span class="title">netty</span>.<span class="title">domain</span>.<span class="title">MsgBody</span></span></span><br><span class="line">2019-08-04 14:06:01 接收到消息内容：&#123;"channelId": "abc14b89","msgInfo": "你好，使用protobuf通信格式的服务端，我是https://bugstack.cn博主，付政委。这是我的公众号&lt;bugstack虫洞栈&gt;，关注我获取案例源码。"&#125;</span><br><span class="line"><span class="number">2019</span>-<span class="number">08</span>-<span class="number">04</span> <span class="number">14</span>:<span class="number">06</span>:<span class="number">01</span> 接收到消息类型：<span class="class"><span class="keyword">class</span> <span class="title">org</span>.<span class="title">itstack</span>.<span class="title">demo</span>.<span class="title">netty</span>.<span class="title">domain</span>.<span class="title">MsgBody</span></span></span><br><span class="line">2019-08-04 14:06:01 接收到消息内容：&#123;"channelId": "abc14b89","msgInfo": "你好，使用protobuf通信格式的服务端，我是https://bugstack.cn博主，付政委。这是我的公众号&lt;bugstack虫洞栈&gt;，关注我获取案例源码。"&#125;</span><br><span class="line">异常信息：</span><br><span class="line">远程主机强迫关闭了一个现有的连接。</span><br><span class="line">客户端断开链接/<span class="number">127.0</span>.0.1:<span class="number">7397</span></span><br><span class="line"></span><br><span class="line">Process finished with exit code -<span class="number">1</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>客户端执行结果</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">itstack-demo-netty client start done. &#123;关注公众号：bugstack虫洞栈，获取源码&#125;</span><br><span class="line">链接报告开始</span><br><span class="line">链接报告信息：本客户端链接到服务端。channelId：abc14b89</span><br><span class="line">链接报告IP:<span class="number">127.0</span>.0.1</span><br><span class="line">链接报告Port:<span class="number">51218</span></span><br><span class="line">链接报告完毕</span><br><span class="line"><span class="number">2019</span>-<span class="number">08</span>-<span class="number">04</span> <span class="number">14</span>:<span class="number">06</span>:<span class="number">01</span> 接收到消息类型：<span class="class"><span class="keyword">class</span> <span class="title">org</span>.<span class="title">itstack</span>.<span class="title">demo</span>.<span class="title">netty</span>.<span class="title">domain</span>.<span class="title">MsgBody</span></span></span><br><span class="line">2019-08-04 14:06:01 接收到消息内容：&#123;"channelId": "807679da","msgInfo": "通知客户端链接建立成功 Sun Aug 04 14:06:01 CST 2019 127.0.0.1\r\n"&#125;</span><br><span class="line"></span><br><span class="line">Process finished with exit code -<span class="number">1</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="微信公众号：bugstack虫洞栈，欢迎您的关注-amp-获取源码！"><a href="#微信公众号：bugstack虫洞栈，欢迎您的关注-amp-获取源码！" class="headerlink" title="微信公众号：bugstack虫洞栈，欢迎您的关注&amp;获取源码！"></a>微信公众号：bugstack虫洞栈，欢迎您的关注&amp;获取源码！</h2><p><img src="https://bugstack.cn/wp-content/uploads/2019/08/qrcode清晰.png" alt="微信公众号：bugstack虫洞栈，欢迎您的关注&amp;获取源码！"></p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="//itstack.org/2019/08/09/netty案例，netty4-1中级拓展篇二《Netty使用Protobuf传输数据》/" title="netty案例，netty4.1中级拓展篇二《Netty使用Protobuf传输数据》" target="_blank" rel="external">//itstack.org/2019/08/09/netty案例，netty4-1中级拓展篇二《Netty使用Protobuf传输数据》/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/fuzhengwei" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/touxiang.png" class="img-rounded w-full" alt>
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/fuzhengwei" target="_blank"><span class="text-dark">付政委</span><small class="ml-1x">沉淀、分享、成长</small></a></h3>
        <div>个人简介。</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
           
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2019/08/09/netty案例，netty4-1中级拓展篇三《Netty传输Java对象》/" title="netty案例，netty4.1中级拓展篇三《Netty传输Java对象》"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;Newer</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2019/08/09/netty案例，netty4-1中级拓展篇一《Netty与SpringBoot整合》/" title="netty案例，netty4.1中级拓展篇一《Netty与SpringBoot整合》"><span>Older&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>$</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>Maybe you could buy me a cup of coffee.</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="Scan Qrcode" title="Scan">
              </div>
              <p class="text-muted mv">Scan this qrcode</p>
              <p class="text-grey">Open alipay app scan this qrcode, buy me a coffee!</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="Scan Qrcode" title="Scan">
              </div>
              <p class="text-muted mv">Scan this qrcode</p>
              <p class="text-grey">Open wechat app scan this qrcode, buy me a coffee!</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> alipay</a>
              </li>
              <li role="presentation" class>
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> wechat payment</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/fuzhengwei" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script src="/js/plugin.min.js"></script>
<script src="/js/application.js"></script>

    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>





   




   
    
  <!-- <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"> -->
  <script src="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script>
  <script type="text/javascript">
  var gitalk = new Gitalk({
    clientID: 'cc86f59495cf11ebf26b',
    clientSecret: 'e2dc4ec1d87b3744e29412623fa94e70ae099636',
    repo: 'fuzhengwei.github.com',
    owner: 'fuzhengwei',
    admin: ['fuzhengwei'],
    id: md5(location.pathname),
    distractionFreeMode: true
  })
  gitalk.render('comments')
  </script>

      







</body>
</html>